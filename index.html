<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lab technician scheduling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #d5dde8;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --accent: #0ea5e9;
      --pill-radius: 999px;
      --sasi: #22c55e;
      --viviana: #6366f1;
      --simon: #0ea5e9;
      --lara: #f97316;
      --stefanija: #eab308;
      --klara: #1e3a8a;

    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--text-main);
      padding: 16px;
      display: flex;
      justify-content: center;
    }
    .app {
      background: var(--card);
      border-radius: 16px;
      padding: 20px 20px 24px;
      max-width: 1100px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.25);
    }
    h1 {
      font-size: 20px;
      font-weight: 600;
    }
    .subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }
    .user-label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .user-name {
      font-weight: 600;
      color: var(--accent);
    }

    .top-row {
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.6fr);
      gap: 16px;
      margin-bottom: 12px;
    }
    .card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px 12px 14px;
      border: 1px solid var(--border);
    }
    .card h2 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .legend {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: var(--pill-radius);
      background: #e5e7eb;
      font-size: 11px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }
    .legend-info {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 8px;
    }
    .slot-row {
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .slot-row .pill {
      flex: 1 1 0;
      min-width: 0;
    }
    label {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 3px;
    }
    select, input[type="text"], input[type="datetime-local"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
      background: white;
    }
    select:focus, input:focus {
      outline: 2px solid rgba(14, 165, 233, 0.4);
      border-color: var(--accent);
    }
    .form-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }
    button {
      border: none;
      border-radius: var(--pill-radius);
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: var(--text-main);
    }
    .error {
      font-size: 11px;
      color: #dc2626;
      margin-top: 4px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      margin-top: 8px;
    }
    .month-title {
      font-weight: 600;
      font-size: 14px;
    }
    .month-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .nav-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 11px;
      cursor: pointer;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
    }
    .weekday {
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .day-cell {
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid var(--border);
      min-height: 78px;
      padding: 4px 4px 4px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
      position: relative;
      overflow: hidden;
    }
    .day-number {
      font-weight: 500;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .day-cell.today .day-number {
      color: var(--accent);
      font-weight: 700;
    }
    .day-cell.other-month {
      background: #f3f4f6;
      opacity: 0.7;
    }
    .pill {
      border-radius: var(--pill-radius);
      padding: 2px 6px;
      font-size: 10px;
      color: white;
      cursor: pointer;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      border: 1px solid rgba(15,23,42,0.08);
    }
/* Bigger pills when showing only my assignments */
/* --- MY view (technician) pills: equal + neat --- */
/* --- MY view (technician) pills: equal + neat, always 2 lines --- */
.pill.my-only{
  padding: 8px 10px;
  border-radius: 12px;
  width: 100%;

  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 4px;

  height: 54px;          /* <-- STAŁA WYSOKOŚĆ dla wszystkich */
  overflow: hidden;
  white-space: normal;
  line-height: 1.2;
}

/* line 1: task (clamp to 1 line or 2 - tu ustawiam 1 linię, bo masz osobną linię czasu) */
.pill.my-only .t{
  font-weight: 600;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

/* line 2: time */
.pill.my-only .tm{
  font-size: 10px;
  opacity: 0.95;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}



    
    .pill.sasi { background: var(--sasi); }
    .pill.viviana { background: var(--viviana); }
    .pill.simon { background: var(--simon); }
    .pill.lara { background: var(--lara); }
    .pill.stefanija { background: var(--stefanija); }
    .pill.klara { background: var(--klara); }

    /* --- ABSENCE pills: same color, but hatched/pattern --- */
.pill.absence{
  /* keep technician background-color from .pill.sasi/.viviana/... */
  background-image: repeating-linear-gradient(
    45deg,
    rgba(255,255,255,0.28) 0px,
    rgba(255,255,255,0.28) 6px,
    rgba(255,255,255,0.00) 6px,
    rgba(255,255,255,0.00) 12px
  );
  border: 1px dashed rgba(255,255,255,0.65);
}
/* Booking nadpisany przez absencję (admin view / wszyscy) */
.pill.overridden {
  outline: 3px solid #ef4444;
  outline-offset: -2px;
  box-shadow: 0 0 0 2px rgba(239,68,68,0.25);
  filter: saturate(0.85);
}


    
/* optional: make absence slightly more “label-like” */
.pill.absence .t { font-weight: 700; }



    .info-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .top-row {
        grid-template-columns: 1fr;
      }
    }

  /* --- Booking modal --- */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}
.modal-card {
  width: min(560px, 92vw);
  background: #fff;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.18);
  border: 1px solid var(--border);
}
.modal-row {
  display: grid;
  gap: 8px;
  margin-top: 10px;
}
.modal-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  align-items: center;
  margin-top: 12px;
  flex-wrap: wrap;
}
.modal-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}
.modal-title strong { font-size: 14px; }
.modal-close {
  border: none;
  background: #e5e7eb;
  border-radius: 999px;
  padding: 6px 10px;
  cursor: pointer;
}
.modal-hint {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 6px;
}
.modal-error {
  font-size: 11px;
  color: #dc2626;
  margin-top: 8px;
}

/* --- absence mini calendar day cells --- */
.am-day{
  border: 1px solid var(--border);
  background: #fff;
  border-radius: 10px;
  min-height: 34px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 12px;
  cursor: pointer;
  user-select: none;
}
.am-day.off { opacity: 0.35; background:#f3f4f6; cursor: default; }
.am-day.sel{
  outline: 2px solid rgba(14, 165, 233, 0.45);
  border-color: var(--accent);
  background: #eef7ff;
  font-weight: 700;
}
.am-day.today{
  border-color: rgba(14,165,233,0.6);
}
  
  
  </style>
</head>
<body>
  <div class="app">
    <div class="app-header">
      <div>
        <div class="title-row">
          <div class="status-dot"></div>
          <h1>Lab technician scheduling</h1>
        </div>
        <div class="subtitle">
          One shared calendar; colours = technicians. Data stored in Firestore.
        </div>
      </div>
      <div class="user-label">
        Logged in as: <span class="user-name" id="currentUserLabel"></span>
      </div>
    </div>

    <div class="top-row">
      <div class="card">
        <h2>New assignment</h2>
        <div class="form-grid">
          <div>
            <label for="technician">Technician</label>
            <select id="technician">
              <option value="Sasi">Sasi</option>
              <option value="Viviana">Viviana</option>
              <option value="Simon">Simon</option>
              <option value="Lara">Lara</option>
              <option value="Stefanija">Stefanija</option>
              <option value="Klara">Klara</option>

            </select>
          </div>
          <div>
            <label for="task">Task /  description</label>
            <input id="task" type="text" placeholder="inventory, BET, lab tour..." />
          </div>
          <div>
            <label for="start">Date &amp; time from</label>
            <input id="start" type="datetime-local" step="1800" />
          </div>
          <div>
            <label for="end">Date &amp; time to</label>
            <input id="end" type="datetime-local" step="1800" />
          </div>
        </div>
        <div class="form-actions">
  <button class="btn-primary" id="addBookingBtn">Add assignment</button>

  <!-- NEW: Absence (visible for admin + technician via JS) -->
  <button class="btn-secondary" id="addAbsenceBtn" style="display:none;">Add absence</button>

  <div class="error" id="error"></div>
</div>

        <div class="info-text">
          Time step = 30 min (automatically rounded). Overlaps for the same technician are blocked.
        </div>
      </div>

      <div class="card">
        <h2>Legend</h2>
        <div class="legend">
          <div class="legend-item"><span class="legend-dot" style="background: var(--sasi)"></span>Sasi</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--viviana)"></span>Viviana</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--simon)"></span>Simon</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--lara)"></span>Lara</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--stefanija)"></span>Stefanija</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--klara)"></span>Klara</div>
        </div>
        <div class="legend-info">
  Click a coloured bar in the calendar to view details. If it is your assignment – you can edit/delete it.
  <br><br>
  <b>Absence has priority</b> (Vacation / Sick) and is shown as a <b>hatched</b> bar in the technician’s colour.
  <br>
  Any assignment that falls on an absence day is kept, but marked with a <b>red outline</b> (overridden by absence).
</div>

      </div>
    </div>

    <div class="card">
      <div class="calendar-header">
<div id="filterContainer" style="margin-bottom:8px; display:none;">
<select id="technicianFilter" style="padding:6px 8px; border-radius:8px; border:1px solid #d5dde8; font-size:12px;">
  <option value="ALL">All technicians</option>
  <option value="MY">Show only my assignments</option>
  <option value="Sasi">Sasi</option>
  <option value="Viviana">Viviana</option>
  <option value="Simon">Simon</option>
  <option value="Lara">Lara</option>
  <option value="Stefanija">Stefanija</option>
  <option value="Klara">Klara</option>
</select>

</div>


        
        <div class="month-title" id="monthTitle"></div>
        <div class="month-nav">
          <button class="nav-btn" id="prevMonth">&lt;</button>
          <button class="nav-btn" id="todayBtn">Today</button>
          <button class="nav-btn" id="nextMonth">&gt;</button>
        </div>
      </div>
      <div class="calendar-grid">
        <div class="weekday">Mon</div>
        <div class="weekday">Tue</div>
        <div class="weekday">Wed</div>
        <div class="weekday">Thu</div>
        <div class="weekday">Fri</div>
        <div class="weekday">Sat</div>
        <div class="weekday">Sun</div>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="card" id="bookingsCard">
      <h2>Assignments list</h2>
      <div id="bookingsList" class="info-text">
        Loading…
      </div>
    </div>
  </div>


<!-- Booking details / edit modal -->
<div id="bookingModal" class="modal-backdrop">
  <div class="modal-card">
    <div class="modal-title">
      <strong id="bmTitle">Assignment</strong>
      <button class="modal-close" id="bmClose">Close</button>
    </div>


    
    <div class="modal-hint" id="bmMeta"></div>

    <!-- VIEW MODE -->
    <div id="bmView" class="modal-row">
      <div><b>Technician:</b> <span id="bmTech"></span></div>
      <div><b>Task:</b> <span id="bmTask"></span></div>
      <div><b>From:</b> <span id="bmFrom"></span></div>
      <div><b>To:</b> <span id="bmTo"></span></div>
      <div><b>Created by:</b> <span id="bmBy"></span></div>
    </div>

    <!-- EDIT MODE -->
    <div id="bmEdit" class="modal-row" style="display:none;">
      <div>
        <label style="font-size:11px; color:#6b7280; display:block; margin-bottom:4px;">Technician</label>
        <select id="bmEditTech" style="width:100%; padding:8px; border-radius:10px; border:1px solid #d5dde8;">
          <option value="Sasi">Sasi</option>
          <option value="Viviana">Viviana</option>
          <option value="Simon">Simon</option>
          <option value="Lara">Lara</option>
          <option value="Stefanija">Stefanija</option>
          <option value="Klara">Klara</option>
        </select>
      </div>

      <div>
        <label style="font-size:11px; color:#6b7280; display:block; margin-bottom:4px;">Task</label>
        <input id="bmEditTask" type="text" style="width:100%; padding:8px; border-radius:10px; border:1px solid #d5dde8;" />
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
        <div>
          <label style="font-size:11px; color:#6b7280; display:block; margin-bottom:4px;">From</label>
          <input id="bmEditStart" type="datetime-local" step="1800" style="width:100%; padding:8px; border-radius:10px; border:1px solid #d5dde8;" />
        </div>
        <div>
          <label style="font-size:11px; color:#6b7280; display:block; margin-bottom:4px;">To</label>
          <input id="bmEditEnd" type="datetime-local" step="1800" style="width:100%; padding:8px; border-radius:10px; border:1px solid #d5dde8;" />
        </div>
      </div>

      <div class="modal-error" id="bmErr"></div>
    </div>

    <div class="modal-actions" id="bmActions">
      <button class="btn-secondary" id="bmEditBtn">Edit</button>
      <button class="btn-primary" id="bmSaveBtn" style="display:none;">Save</button>
      <button class="btn-secondary" id="bmCancelEditBtn" style="display:none;">Cancel</button>
      <button class="btn-secondary" id="bmDeleteBtn" style="background:#fee2e2; border:1px solid #fecaca; color:#b91c1c;">Delete</button>
    </div>
  </div>
</div>

<!-- Absence modal -->
<div id="absenceModal" class="modal-backdrop">
  <div class="modal-card">
    <div class="modal-title">
      <strong id="amTitle">Absence</strong>
      <button class="modal-close" id="amClose">Close</button>
    </div>

    <div class="modal-hint" id="amMeta">Select days (no hours). Click to toggle.</div>

    <div class="modal-row">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:end;">
        <div>
          <label style="font-size:11px; color:#6b7280; display:block; margin-bottom:4px;">Technician</label>
          <select id="amTech" style="width:100%; padding:8px; border-radius:10px; border:1px solid #d5dde8;">
            <option value="Sasi">Sasi</option>
            <option value="Viviana">Viviana</option>
            <option value="Simon">Simon</option>
            <option value="Lara">Lara</option>
            <option value="Stefanija">Stefanija</option>
            <option value="Klara">Klara</option>
          </select>
        </div>

        <div>
          <label style="font-size:11px; color:#6b7280; display:block; margin-bottom:4px;">Type</label>
          <select id="amType" style="width:100%; padding:8px; border-radius:10px; border:1px solid #d5dde8;">
            <option value="Vacation">Vacation</option>
            <option value="Sick">Sick</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>

      <div>
        <label style="font-size:11px; color:#6b7280; display:block; margin-bottom:4px;">Note (optional)</label>
        <input id="amNote" type="text" style="width:100%; padding:8px; border-radius:10px; border:1px solid #d5dde8;"
               placeholder="e.g., annual leave, conference travel..." />
      </div>

      <!-- mini calendar header -->
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:6px;">
        <div style="font-weight:600; font-size:13px;" id="amMonthTitle">Month</div>
        <div style="display:flex; gap:6px;">
          <button class="btn-secondary" id="amPrev" style="font-size:11px; padding:5px 10px;">&lt;</button>
          <button class="btn-secondary" id="amToday" style="font-size:11px; padding:5px 10px;">Today</button>
          <button class="btn-secondary" id="amNext" style="font-size:11px; padding:5px 10px;">&gt;</button>
        </div>
      </div>

      <!-- mini calendar grid -->
      <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; margin-top:6px;">
        <div style="text-align:center; font-size:11px; color:#6b7280;">Mon</div>
        <div style="text-align:center; font-size:11px; color:#6b7280;">Tue</div>
        <div style="text-align:center; font-size:11px; color:#6b7280;">Wed</div>
        <div style="text-align:center; font-size:11px; color:#6b7280;">Thu</div>
        <div style="text-align:center; font-size:11px; color:#6b7280;">Fri</div>
        <div style="text-align:center; font-size:11px; color:#6b7280;">Sat</div>
        <div style="text-align:center; font-size:11px; color:#6b7280;">Sun</div>
      </div>
      <div id="amGrid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; margin-top:4px;"></div>

      <div class="modal-error" id="amErr"></div>
    </div>

    <div class="modal-actions">
      <button class="btn-secondary" id="amClearBtn">Clear</button>
      <button class="btn-primary" id="amSaveBtn">Save absence</button>
    </div>
  </div>
</div>

  

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

  import {
    getAuth,
    setPersistence,
  browserLocalPersistence,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    sendPasswordResetEmail,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy,
  where,
  Timestamp,
  doc,
  deleteDoc,
  updateDoc,
  getDoc,
  writeBatch
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";


  // -------------------------
  // Firebase init
  // -------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyB4_rAT7I55-9h-5rRRRXastEuPT6srqVs",
    authDomain: "lab-technicians-booking.firebaseapp.com",
    projectId: "lab-technicians-booking",
    storageBucket: "lab-technicians-booking.firebasestorage.app",
    messagingSenderId: "897254183022",
    appId: "1:897254183022:web:5ed0e7b98fa5553717967f",
    measurementId: "G-ZF5Z2GLBK7"
  };

  const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

try {
  await setPersistence(auth, browserLocalPersistence);
} catch (e) {
  console.error("setPersistence failed:", e);
}


  const db = getFirestore(app);

  const bookingsCol = collection(db, "bookings");

  // -------------------------
  // UI helpers: login modal
  // -------------------------
  const appRoot = document.querySelector(".app");
  const userLabelEl = document.getElementById("currentUserLabel");
  const errorEl = document.getElementById("error");

  function ensureLoginModal() {
    if (document.getElementById("loginModal")) return;

    const modal = document.createElement("div");
    modal.id = "loginModal";
    modal.style.position = "fixed";
    modal.style.inset = "0";
    modal.style.background = "rgba(15,23,42,0.45)";
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.style.zIndex = "9999";
    modal.innerHTML = `
      <div style="width:min(520px, 92vw); background:#fff; border-radius:16px; padding:18px; box-shadow: 0 15px 35px rgba(0,0,0,0.18);">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;">
          <div style="font-weight:700;">Sign in</div>
          <div style="font-size:12px; color:#6b7280;">Email + password</div>
        </div>

        <div style="display:grid; gap:10px;">
          <div>
            <label style="font-size:11px; color:#6b7280; display:block; margin-bottom:4px;">Email</label>
            <input id="loginEmail" type="email" style="width:100%; padding:10px; border:1px solid #d5dde8; border-radius:10px;" placeholder="name@innorenew.eu" />
          </div>
          <div>
            <label style="font-size:11px; color:#6b7280; display:block; margin-bottom:4px;">Password</label>
            <input id="loginPass" type="password" style="width:100%; padding:10px; border:1px solid #d5dde8; border-radius:10px;" placeholder="••••••••" />
          </div>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px;">
            <button id="btnLogin" style="border:none; border-radius:999px; padding:8px 14px; background:#0ea5e9; color:#fff; cursor:pointer;">Sign in</button>
            <button id="btnForgot" style="border:none; border-radius:999px; padding:8px 14px; background:#e5e7eb; cursor:pointer;">Forgot password</button>
            <div id="loginMsg" style="font-size:12px; color:#dc2626;"></div>
          </div>

          <div style="font-size:11px; color:#6b7280; margin-top:4px; line-height:1.35;">
            If you have a temporary password, sign in once and then use <b>Forgot password</b> to set your own.
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    const msg = modal.querySelector("#loginMsg");
    const emailEl = modal.querySelector("#loginEmail");
    const passEl = modal.querySelector("#loginPass");

    // --- remember last email + better autofill ---
emailEl.setAttribute("autocomplete", "email");
emailEl.setAttribute("name", "email");

passEl.setAttribute("autocomplete", "current-password");
passEl.setAttribute("name", "password");

const lastEmail = localStorage.getItem("lastEmail");
if (lastEmail && !emailEl.value) {
  emailEl.value = lastEmail;
}


    modal.querySelector("#btnLogin").addEventListener("click", async () => {
      msg.textContent = "";
      const email = (emailEl.value || "").trim();
      const pass = passEl.value || "";
localStorage.setItem("lastEmail", email);

      
      if (!email || !pass) {
        msg.textContent = "Please enter email and password.";
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        // onAuthStateChanged will close modal
      } catch (e) {
        console.error(e);
        msg.textContent = "Login failed. Check email/password.";
      }
    });

    modal.querySelector("#btnForgot").addEventListener("click", async () => {
      msg.textContent = "";
      const email = (emailEl.value || "").trim();
localStorage.setItem("lastEmail", email);

      
      if (!email) {
        msg.textContent = "Type your email first (then click Forgot password).";
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        msg.style.color = "#16a34a";
        msg.textContent = "Password reset email sent.";
      } catch (e) {
        console.error(e);
        msg.style.color = "#dc2626";
        msg.textContent = "Could not send reset email (check address).";
      }
    });
  }

  function showLogin() {
    ensureLoginModal();
    document.getElementById("loginModal").style.display = "flex";
    appRoot.style.filter = "blur(3px)";
    appRoot.style.pointerEvents = "none";
  }

  function hideLogin() {
    const modal = document.getElementById("loginModal");
    if (modal) modal.style.display = "none";
    appRoot.style.filter = "";
    appRoot.style.pointerEvents = "";
  }

  // -------------------------
  // Roles / profile (from Firestore /users/{uid})
  // -------------------------
  let currentProfile = null; // { role, displayName, technicianName }
  let currentEmail = null;
  let currentUid = null;

  async function loadProfile(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (!snap.exists()) return null;
    return snap.data();
  }

  function isAdmin() {
    return currentProfile?.role === "admin";
  }
  function isResearcher() {
    return currentProfile?.role === "researcher";
  }
  function isTechnician() {
    return currentProfile?.role === "technician";
  }

  // -------------------------
  // Your existing UI elements
  // -------------------------
  const monthTitleEl = document.getElementById("monthTitle");
  const calendarGridEl = document.getElementById("calendarGrid");
  const bookingsListEl = document.getElementById("bookingsList");
const filterContainer = document.getElementById("filterContainer");
const technicianFilter = document.getElementById("technicianFilter");

   

  const technicianSelect = document.getElementById("technician");
  const taskInput = document.getElementById("task");
  const startInput = document.getElementById("start");
  const endInput = document.getElementById("end");
  const addBtn = document.getElementById("addBookingBtn");
   const addAbsenceBtn = document.getElementById("addAbsenceBtn");

// Absence modal refs
const absenceModal = document.getElementById("absenceModal");
const amClose = document.getElementById("amClose");
const amTitle = document.getElementById("amTitle");
const amMeta = document.getElementById("amMeta");
const amTech = document.getElementById("amTech");
const amType = document.getElementById("amType");
const amNote = document.getElementById("amNote");
const amMonthTitle = document.getElementById("amMonthTitle");
const amPrev = document.getElementById("amPrev");
const amToday = document.getElementById("amToday");
const amNext = document.getElementById("amNext");
const amGrid = document.getElementById("amGrid");
const amErr = document.getElementById("amErr");
const amSaveBtn = document.getElementById("amSaveBtn");
const amClearBtn = document.getElementById("amClearBtn");



// -------------------------
// Booking modal (view/edit)
// -------------------------
const bookingModal = document.getElementById("bookingModal");
const bmClose = document.getElementById("bmClose");
const bmTitle = document.getElementById("bmTitle");
const bmMeta = document.getElementById("bmMeta");

const bmView = document.getElementById("bmView");
const bmEdit = document.getElementById("bmEdit");

const bmTech = document.getElementById("bmTech");
const bmTask = document.getElementById("bmTask");
const bmFrom = document.getElementById("bmFrom");
const bmTo = document.getElementById("bmTo");
const bmBy = document.getElementById("bmBy");

const bmEditTech = document.getElementById("bmEditTech");
const bmEditTask = document.getElementById("bmEditTask");
const bmEditStart = document.getElementById("bmEditStart");
const bmEditEnd = document.getElementById("bmEditEnd");
const bmErr = document.getElementById("bmErr");

const bmEditBtn = document.getElementById("bmEditBtn");
const bmSaveBtn = document.getElementById("bmSaveBtn");
const bmCancelEditBtn = document.getElementById("bmCancelEditBtn");
const bmDeleteBtn = document.getElementById("bmDeleteBtn");

let modalBooking = null;     // aktualnie oglądany booking (obiekt z bookings[])
let modalEditMode = false;   // czy modal jest w trybie edycji

   const TECHNICIANS = ["Sasi", "Viviana", "Simon", "Lara", "Stefanija", "Klara"];
   
function openBookingModal(booking) {
  modalBooking = booking;
  modalEditMode = false;
  bmErr.textContent = "";

  const s = booking.start.toDate();
  const e = booking.end.toDate();
  const createdLabel = booking.createdByDisplayName || booking.createdByEmail || booking.createdBy || "unknown";

  bmTitle.textContent = (booking.kind === "absence")
  ? `Absence – ${booking.technician}`
  : `Assignment – ${booking.technician}`;

  bmMeta.textContent = canEditOrDelete(booking) ? "You can edit/delete this assignment." : "Read-only.";

  // fill view
  bmTech.textContent = booking.technician || "";
  bmTask.textContent = booking.task || "";
  bmFrom.textContent = formatDateTime(s);
  bmTo.textContent = formatDateTime(e);
  bmBy.textContent = createdLabel;

  // prepare edit fields
  bmEditTech.value = booking.technician || TECHNICIANS[0];
  bmEditTask.value = booking.task || "";
  bmEditStart.value = toLocalInputValue(s);
  bmEditEnd.value = toLocalInputValue(e);

  // permissions: show/hide actions
  const canAct = canEditOrDelete(booking);
  bmEditBtn.style.display = canAct ? "inline-flex" : "none";
  bmDeleteBtn.style.display = canAct ? "inline-flex" : "none";

  // always start in view mode
  bmView.style.display = "grid";
  bmEdit.style.display = "none";
  bmSaveBtn.style.display = "none";
  bmCancelEditBtn.style.display = "none";
  bmEditBtn.style.display = canAct ? "inline-flex" : "none";

  bookingModal.style.display = "flex";
  appRoot.style.filter = "blur(3px)";
  appRoot.style.pointerEvents = "none";
}

function closeBookingModal() {
  bookingModal.style.display = "none";
  appRoot.style.filter = "";
  appRoot.style.pointerEvents = "";
  modalBooking = null;
  modalEditMode = false;
  bmErr.textContent = "";
}

bmClose.addEventListener("click", closeBookingModal);
bookingModal.addEventListener("click", (e) => {
  if (e.target === bookingModal) closeBookingModal(); // klik w tło
});

function setModalEditMode(on) {
  modalEditMode = on;
  bmErr.textContent = "";
  if (on) {
    bmView.style.display = "none";
    bmEdit.style.display = "grid";
    bmSaveBtn.style.display = "inline-flex";
    bmCancelEditBtn.style.display = "inline-flex";
    bmEditBtn.style.display = "none";
  } else {
    bmView.style.display = "grid";
    bmEdit.style.display = "none";
    bmSaveBtn.style.display = "none";
    bmCancelEditBtn.style.display = "none";
    bmEditBtn.style.display = "inline-flex";
  }
}

   

  // Add a logout button in header (minimal)
  (function addLogoutBtnOnce() {
    if (document.getElementById("btnLogout")) return;
    const header = document.querySelector(".app-header");
    const btn = document.createElement("button");
    btn.id = "btnLogout";
    btn.className = "btn-secondary";
    btn.textContent = "Logout";
    btn.style.fontSize = "11px";
    btn.style.padding = "6px 12px";
    btn.addEventListener("click", async () => {
      await signOut(auth);
    });
    header.appendChild(btn);
  })();

  // -------------------------
  // Calendar logic (mostly your original)
  // -------------------------
  

   function buildFilterOptionsForRole() {
  if (isTechnician()) {
    // Technician: ONLY ALL + MY
    technicianFilter.innerHTML = `
      <option value="ALL">All technicians</option>
      <option value="MY">Show only my assignments</option>
    `;
  } else {
    // Admin/Researcher: ALL + MY(created by me) + specific technicians
    technicianFilter.innerHTML = `
      <option value="ALL">All technicians</option>
      <option value="MY">Show only assignments I created</option>
      ${TECHNICIANS.map((t) => `<option value="${t}">${t}</option>`).join("")}
    `;
  }
}


  function toJSDate(value) {
    if (!value) return null;
    return new Date(value);
  }

  function roundTo30(date) {
    const minutes = date.getMinutes();
    let rounded = Math.round(minutes / 30) * 30;
    if (rounded === 60) {
      date.setHours(date.getHours() + 1);
      rounded = 0;
    }
    date.setMinutes(rounded, 0, 0);
    return date;
  }

  function toLocalInputValue(d) {
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off * 60 * 1000);
    return local.toISOString().slice(0, 16);
  }

  function normalizeInputTo30(input) {
    if (!input.value) return;
    const d = toJSDate(input.value);
    if (!d) return;
    const rounded = roundTo30(d);
    input.value = toLocalInputValue(rounded);
  }

  function sameDay(d1, d2) {
    return (
      d1.getFullYear() === d2.getFullYear() &&
      d1.getMonth() === d2.getMonth() &&
      d1.getDate() === d2.getDate()
    );
  }

  function overlaps(aStart, aEnd, bStart, bEnd) {
    return aStart < bEnd && bStart < aEnd;
  }


function isOverriddenByAbsence(booking) {
  if (!booking || booking.kind === "absence") return false;

  const s = booking.start.toDate();
  const e = booking.end.toDate();

  return bookings.some((a) => {
    if (a.kind !== "absence") return false;
    if (a.technician !== booking.technician) return false;
    const as = a.start.toDate();
    const ae = a.end.toDate();
    return overlaps(s, e, as, ae);
  });
}

   
  function formatDateTime(dt) {
    return dt.toLocaleString([], {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

// -------------------------
// Absence picker state + helpers
// -------------------------
let amMonth = null;
let amYear = null;
let selectedAbsenceDays = new Set(); // stores "YYYY-MM-DD"

function ymdKey(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function startOfDayLocal(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}

function endOfDayLocal(d){
  const x = new Date(d);
  x.setHours(23,59,59,999);
  return x;
}

function openAbsenceModal(){
  amErr.textContent = "";
  selectedAbsenceDays.clear();

  // who can use?
  const canUse = isAdmin() || isTechnician();
  if (!canUse) {
    errorEl.textContent = "Absence is available only for admin/technicians.";
    return;
  }

  // technician selection rules:
  if (isTechnician()) {
    amTech.value = currentProfile?.technicianName || TECHNICIANS[0];
    amTech.disabled = true;
  } else {
    // admin can select technician (default = current form dropdown)
    amTech.value = technicianSelect.value || TECHNICIANS[0];
    amTech.disabled = false;
  }

  const now = new Date();
  amMonth = now.getMonth();
  amYear = now.getFullYear();
  renderAbsenceCalendar();

  absenceModal.style.display = "flex";
  appRoot.style.filter = "blur(3px)";
  appRoot.style.pointerEvents = "none";
}

addAbsenceBtn.addEventListener("click", () => {
  openAbsenceModal();
});

   
function closeAbsenceModal(){
  absenceModal.style.display = "none";
  appRoot.style.filter = "";
  appRoot.style.pointerEvents = "";
  amErr.textContent = "";
  selectedAbsenceDays.clear();
}

amClose.addEventListener("click", closeAbsenceModal);
absenceModal.addEventListener("click", (e) => {
  if (e.target === absenceModal) closeAbsenceModal();
});

function renderAbsenceCalendar(){
  amGrid.innerHTML = "";

  const firstDay = new Date(amYear, amMonth, 1);
  const firstWeekday = (firstDay.getDay() + 6) % 7; // Mon=0
  const totalCells = 42;
  const today = new Date();

  for (let i=0; i<totalCells; i++){
    const dateObj = new Date(amYear, amMonth, 1 - firstWeekday + i);
    const isCurrentMonth = dateObj.getMonth() === amMonth;

    const cell = document.createElement("div");
    cell.className = "am-day";
    cell.textContent = dateObj.getDate();

    if (!isCurrentMonth) cell.classList.add("off");

    if (sameDay(dateObj, today)) cell.classList.add("today");

    const key = ymdKey(dateObj);
    if (selectedAbsenceDays.has(key)) cell.classList.add("sel");

    // only allow click on current month days
    if (isCurrentMonth){
      cell.addEventListener("click", () => {
        if (selectedAbsenceDays.has(key)) selectedAbsenceDays.delete(key);
        else selectedAbsenceDays.add(key);
        renderAbsenceCalendar();
      });
    }

    amGrid.appendChild(cell);
  }

  const monthName = new Date(amYear, amMonth, 1).toLocaleString("en", { month: "long", year: "numeric" });
  amMonthTitle.textContent = monthName;
}

amPrev.addEventListener("click", () => {
  amMonth--;
  if (amMonth < 0) { amMonth = 11; amYear--; }
  renderAbsenceCalendar();
});
amNext.addEventListener("click", () => {
  amMonth++;
  if (amMonth > 11) { amMonth = 0; amYear++; }
  renderAbsenceCalendar();
});
amToday.addEventListener("click", () => {
  const now = new Date();
  amMonth = now.getMonth();
  amYear = now.getFullYear();
  renderAbsenceCalendar();
});
amClearBtn.addEventListener("click", () => {
  selectedAbsenceDays.clear();
  renderAbsenceCalendar();
});

amSaveBtn.addEventListener("click", async () => {
  amErr.textContent = "";

  const canUse = isAdmin() || isTechnician();
  if (!canUse) {
    amErr.textContent = "No permission.";
    return;
  }

  const technician = amTech.value;
  if (!technician) {
    amErr.textContent = "Select technician.";
    return;
  }

  if (selectedAbsenceDays.size === 0) {
    amErr.textContent = "Select at least one day.";
    return;
  }

  const type = amType.value || "Vacation";
  const note = (amNote.value || "").trim();

  // Build dates sorted
  const keys = Array.from(selectedAbsenceDays).sort(); // YYYY-MM-DD sorts naturally

 
  try {
    const batch = writeBatch(db);

    keys.forEach((k) => {
      const [yy, mm, dd] = k.split("-").map(Number);
      const day = new Date(yy, mm-1, dd);
      const sDay = startOfDayLocal(day);
      const eDay = endOfDayLocal(day);

      const ref = doc(bookingsCol); // auto-id
      batch.set(ref, {
        technician,
        task: `ABSENCE – ${type}${note ? ` – ${note}` : ""}`,
        start: Timestamp.fromDate(sDay),
        end: Timestamp.fromDate(eDay),
        createdAt: Timestamp.now(),

        createdByEmail: currentEmail,
        createdByUid: currentUid,
        createdByDisplayName: currentProfile?.displayName || currentEmail,

        kind: "absence",
        absenceType: type,
        absenceNote: note,
        allDay: true
      });
    });

    await batch.commit();
    closeAbsenceModal();
  } catch (err) {
    console.error(err);
    amErr.textContent = "Save failed (permissions or network).";
  }
});

   
  function technicianClass(name) {
    const n = (name || "").toLowerCase();
    if (n === "sasi") return "sasi";
    if (n === "viviana") return "viviana";
    if (n === "simon") return "simon";
    if (n === "lara") return "lara";
    if (n === "klara") return "klara";
    return "stefanija";
  }

  // View (persist month/year)
  const savedView = JSON.parse(localStorage.getItem("labTechBookingView") || "null");
  let currentMonth, currentYear;
  if (savedView && Number.isInteger(savedView.month) && Number.isInteger(savedView.year)) {
    currentMonth = savedView.month;
    currentYear = savedView.year;
  } else {
    const now = new Date();
    currentMonth = now.getMonth();
    currentYear = now.getFullYear();
  }

  function persistView() {
    localStorage.setItem("labTechBookingView", JSON.stringify({ month: currentMonth, year: currentYear }));
  }

  let bookings = []; // docs
   let currentFilterTechnician = "ALL";

function bookingPassesFilter(b) {
  if (currentFilterTechnician === "ALL") return true;

  if (currentFilterTechnician === "MY") {
    // TECHNICIAN: MY = bookings assigned to me
    if (isTechnician()) {
      return b.technician === currentProfile?.technicianName;
    }
    // ADMIN/RESEARCHER: MY = bookings created by me
    return b.createdByEmail === currentEmail;
  }

  // Named technician filter should be used only by admin/researcher (UI will prevent technicians)
  return b.technician === currentFilterTechnician;
}



   
  let editingBookingId = null;

  // Permissions for UI actions
  function canEditOrDelete(booking) {
    if (isAdmin()) return true;

    // Legacy bookings (no createdByEmail) => read-only for non-admin
    if (!booking.createdByEmail) return false;

    if (isResearcher()) {
      return booking.createdByEmail === currentEmail;
    }
    if (isTechnician()) {
      return booking.createdByEmail === currentEmail && booking.technician === currentProfile?.technicianName;
    }
    return false;
  }

  function canCreateForTechnician(targetTechnician) {
    if (isAdmin()) return true;
    if (isResearcher()) return true;
    if (isTechnician()) return targetTechnician === currentProfile?.technicianName;
    return false;
  }

  function setDefaultDateTimeInputs() {
    const now = new Date();
    const round = Math.ceil(now.getMinutes() / 30) * 30;
    now.setMinutes(round, 0, 0);
    const end = new Date(now.getTime() + 60 * 60 * 1000);

    startInput.value = toLocalInputValue(now);
    endInput.value = toLocalInputValue(end);
  }

  function resetFormToNew() {
    taskInput.value = "";
    editingBookingId = null;
    addBtn.textContent = "Add assignment";
    errorEl.textContent = "";
    setDefaultDateTimeInputs();

    // restore technician select behavior
    if (isTechnician()) {
      technicianSelect.value = currentProfile?.technicianName || TECHNICIANS[0];
      technicianSelect.disabled = true;
    } else {
      technicianSelect.disabled = false;
    }
  }

  function startEdit(booking) {
    if (!canEditOrDelete(booking)) return;

    editingBookingId = booking.id;

    technicianSelect.value = booking.technician;
    taskInput.value = booking.task || "";

    const s = booking.start.toDate();
    const e = booking.end.toDate();

    startInput.value = toLocalInputValue(s);
    endInput.value = toLocalInputValue(e);

    addBtn.textContent = "Save changes";
    errorEl.textContent = `Editing assignment.`;
  }


   bmEditBtn.addEventListener("click", () => {
  if (!modalBooking) return;
  if (!canEditOrDelete(modalBooking)) return;
  setModalEditMode(true);
});

bmCancelEditBtn.addEventListener("click", () => {
  if (!modalBooking) return;
  // wróć do wartości z booking
  const s = modalBooking.start.toDate();
  const e = modalBooking.end.toDate();
  bmEditTech.value = modalBooking.technician || TECHNICIANS[0];
  bmEditTask.value = modalBooking.task || "";
  bmEditStart.value = toLocalInputValue(s);
  bmEditEnd.value = toLocalInputValue(e);
  setModalEditMode(false);
});

bmDeleteBtn.addEventListener("click", async () => {
  if (!modalBooking) return;
  if (!canEditOrDelete(modalBooking)) return;

  const s = modalBooking.start.toDate();
  const e = modalBooking.end.toDate();

  const ok = confirm(
    `${modalBooking.technician} – ${modalBooking.task || "assignment"}\n` +
    `${formatDateTime(s)} → ${formatDateTime(e)}\n\nDelete this assignment?`
  );
  if (!ok) return;

  try {
    await deleteDoc(doc(bookingsCol, modalBooking.id));
    closeBookingModal();
  } catch (err) {
    console.error(err);
    bmErr.textContent = "Delete failed (permissions or network).";
  }
});

bmSaveBtn.addEventListener("click", async () => {
  if (!modalBooking) return;
  if (!canEditOrDelete(modalBooking)) return;

  bmErr.textContent = "";

  // normalize to 30 min
  normalizeInputTo30(bmEditStart);
  normalizeInputTo30(bmEditEnd);

  const technician = bmEditTech.value;
  const task = (bmEditTask.value || "").trim();
  const start = toJSDate(bmEditStart.value);
  const end = toJSDate(bmEditEnd.value);

  if (!technician || !start || !end) {
    bmErr.textContent = "Please fill technician and both dates.";
    return;
  }
  if (end <= start) {
    bmErr.textContent = "End must be later than start.";
    return;
  }

  // role-based: kto może tworzyć/edytować dla kogo
  if (!canCreateForTechnician(technician)) {
    bmErr.textContent = "You cannot assign other technicians.";
    return;
  }

  // Overbooking check (exclude self = modalBooking.id)
  const conflicts = bookings.filter((b) => {
    if (b.technician !== technician) return false;
    if (b.id === modalBooking.id) return false;
    const s = b.start.toDate();
    const e = b.end.toDate();
    return overlaps(start, end, s, e);
  });

  if (conflicts.length > 0) {
    const c = conflicts[0];
    const s = c.start.toDate();
    const e = c.end.toDate();
    bmErr.textContent =
      `Overbooking: ${technician} already booked on ${s.toLocaleDateString()} ` +
      `(${s.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}–` +
      `${e.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}).`;
    return;
  }

  // 3h/day limit (technician self-bookings)
  if (isTechnician() && currentProfile?.technicianName) {
    const bookingDay = start;
    const dayBookings = bookings.filter((b) => {
      if (b.technician !== currentProfile.technicianName) return false;
      if (b.id === modalBooking.id) return false;
      const s = b.start.toDate();
      return sameDay(s, bookingDay) && b.createdByEmail === currentEmail;
    });

    let usedHours = 0;
    dayBookings.forEach((b) => {
      const s = b.start.toDate();
      const e = b.end.toDate();
      usedHours += (e - s) / (1000 * 60 * 60);
    });

    const newHours = (end - start) / (1000 * 60 * 60);
    if (usedHours + newHours > 3.01) {
      bmErr.textContent = "Technicians can book themselves for up to 3 hours per day.";
      return;
    }
  }

  try {
    const ref = doc(bookingsCol, modalBooking.id);
    await updateDoc(ref, {
      technician,
      task,
      start: Timestamp.fromDate(start),
      end: Timestamp.fromDate(end)
    });

    // po zapisie zamknij (snapshot odświeży widok)
    closeBookingModal();
  } catch (err) {
    console.error(err);
    bmErr.textContent = "Save failed (permissions or network).";
  }
});


  function renderCalendar() {
    calendarGridEl.innerHTML = "";

    const firstDay = new Date(currentYear, currentMonth, 1);
    const firstWeekday = (firstDay.getDay() + 6) % 7; // Mon=0
    const prevMonthDays = firstWeekday;
    const totalCells = 42;

    const today = new Date();

    for (let i = 0; i < totalCells; i++) {
      const cell = document.createElement("div");
      cell.className = "day-cell";

      const dayNumberEl = document.createElement("div");
      dayNumberEl.className = "day-number";

      const dateObj = new Date(currentYear, currentMonth, 1 - prevMonthDays + i);
      const isCurrentMonth = dateObj.getMonth() === currentMonth;

      if (!isCurrentMonth) cell.classList.add("other-month");
      if (sameDay(dateObj, today)) cell.classList.add("today");

      dayNumberEl.textContent = dateObj.getDate();
      cell.appendChild(dayNumberEl);

      const startOfDay = new Date(dateObj);
      startOfDay.setHours(0, 0, 0, 0);
      const endOfDay = new Date(dateObj);
      endOfDay.setHours(23, 59, 59, 999);

     const dayBookings = bookings
  .filter((b) => {

  // FILTER (ALL / MY / single technician)
if (!bookingPassesFilter(b)) return false;


    const s = b.start.toDate();
    const e = b.end.toDate();
    return overlaps(s, e, startOfDay, endOfDay);
  })

        .sort((a, b) => a.start.toDate() - b.start.toDate());

      let lastKey = null;
      let currentRow = null;

      dayBookings.forEach((b) => {
        const s = b.start.toDate();
        const e = b.end.toDate();
        const key = `${s.getTime()}-${e.getTime()}`;

        if (key !== lastKey) {
          currentRow = document.createElement("div");
          currentRow.className = "slot-row";
          cell.appendChild(currentRow);
          lastKey = key;
        }

        const pill = document.createElement("div");
        pill.className = "pill " + technicianClass(b.technician);

        const isAbsence = (b.kind === "absence");
if (isAbsence) pill.classList.add("absence");

        // If this is a NORMAL booking and there exists an overlapping ABSENCE for same technician,
// mark it as overridden (absence is higher priority).
if (!isAbsence) {
  const overridden = bookings.some((a) => {
    if (a.kind !== "absence") return false;
    if (a.technician !== b.technician) return false;
    const as = a.start.toDate();
    const ae = a.end.toDate();
    return overlaps(s, e, as, ae);
  });
  if (isOverriddenByAbsence(b)) pill.classList.add("overridden");

}



        const timeLabel = sameDay(s, e)
          ? `${s.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}-${e.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit"
            })}`
          : `${s.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })} → ${e.toLocaleDateString([], {
              month: "2-digit",
              day: "2-digit"
            })}`;

const isMyFilter = (currentFilterTechnician === "MY");
const isTechMyView = isMyFilter && isTechnician();               // technician: MY = assigned to me
const isCreatorMyView = isMyFilter && !isTechnician();           // researcher/admin: MY = created by me


if (isAbsence) {
  const type = b.absenceType || "Absence";

  // Technician MY view: ładna 2-linijkowa
  if (isTechMyView) {
    pill.classList.add("my-only");
    pill.innerHTML = `
      <div class="t">Absence – ${type}</div>
      <div class="tm">All day</div>
    `;

  // Admin/Researcher MY (created by me): też zrób większą, bo tego chcesz
  } else if (isCreatorMyView) {
    pill.classList.add("my-only");
    pill.innerHTML = `
      <div class="t">${b.technician}: Absence – ${type}</div>
      <div class="tm">All day</div>
    `;

  // ALL / filtr po techniku: zwykły tekst (albo też możesz dać my-only jeśli wolisz)
  } else {
    pill.textContent = `${b.technician}: Absence – ${type}`;
  }
}

 else {
  // NORMAL ASSIGNMENTS (only when NOT absence)
  if (isTechMyView) {
    pill.classList.add("my-only");
    pill.innerHTML = `
      <div class="t">${(b.task || "assignment")}</div>
      <div class="tm">${timeLabel}</div>
    `;

    const durH = (e - s) / (1000 * 60 * 60);
    pill.classList.remove("dur-1", "dur-3", "dur-6");
    if (durH <= 1.5) pill.classList.add("dur-1");
    else if (durH <= 3.5) pill.classList.add("dur-3");
    else pill.classList.add("dur-6");

  } else if (isCreatorMyView) {
    pill.textContent = `${b.technician}: ${b.task || "assignment"} – ${timeLabel}`;
    pill.classList.add("my-only");
    pill.classList.remove("dur-1", "dur-3", "dur-6");

  } else {
    pill.textContent = `${b.technician}: ${b.task || "assignment"} (${timeLabel})`;
    pill.classList.remove("my-only", "dur-1", "dur-3", "dur-6");
  }
}






        const createdLabel = b.createdByDisplayName || b.createdByEmail || b.createdBy || "unknown";
        pill.title =
          `${b.technician} – ${b.task || "assignment"}\n` +
          `${formatDateTime(s)}  →  ${formatDateTime(e)}\n` +
          `Created by: ${createdLabel}`;

     pill.addEventListener("click", (ev) => {
  ev.stopPropagation();
  openBookingModal(b);
});


        currentRow.appendChild(pill);
      });

      calendarGridEl.appendChild(cell);
    }

    const monthName = new Date(currentYear, currentMonth, 1).toLocaleString("en", { month: "long", year: "numeric" });
    monthTitleEl.textContent = monthName;
    persistView();
  }

  function renderBookingsList() {
    bookingsListEl.innerHTML = "";

    const monthStart = new Date(currentYear, currentMonth, 1);
    const monthEnd = new Date(currentYear, currentMonth + 1, 1);

   const monthBookings = bookings
  .filter((b) => {

   if (!bookingPassesFilter(b)) return false;


    const s = b.start.toDate();
    return s >= monthStart && s < monthEnd;
  })

      .sort((a, b) => b.start.toDate() - a.start.toDate());

    if (!monthBookings.length) {
      bookingsListEl.textContent = "No assignments in this month.";
      return;
    }

   monthBookings.forEach((b) => {
  const wrapper = document.createElement("div");
  wrapper.style.padding = "8px 10px";
  wrapper.style.marginTop = "6px";
  wrapper.style.borderRadius = "10px";
  wrapper.style.background = "#eef3ff";

  const s = b.start.toDate();
  const e = b.end.toDate();

  const overridden = isOverriddenByAbsence(b);

  if (overridden) {
    wrapper.style.border = "2px solid #ef4444";
    wrapper.style.background = "#fff5f5";

    const badge = document.createElement("div");
    badge.textContent = "OVERWRITTEN BY ABSENCE";
    badge.style.display = "inline-block";
    badge.style.fontSize = "10px";
    badge.style.fontWeight = "700";
    badge.style.padding = "2px 8px";
    badge.style.borderRadius = "999px";
    badge.style.border = "1px solid #ef4444";
    badge.style.color = "#b91c1c";
    badge.style.background = "#fff";
    badge.style.marginBottom = "6px";
    wrapper.appendChild(badge);
  }

  const line1 = document.createElement("div");
  line1.style.fontSize = "12px";
  line1.innerHTML = `<strong>${b.technician}</strong> – ${b.task || "assignment"}`;

  const line2 = document.createElement("div");
  line2.style.fontSize = "11px";
  line2.textContent = `${formatDateTime(s)} → ${formatDateTime(e)}`;

  const createdLabel = b.createdByDisplayName || b.createdByEmail || b.createdBy || "unknown";
  const line3 = document.createElement("div");
  line3.style.fontSize = "11px";
  line3.textContent = `Created by: ${createdLabel}`;

  wrapper.appendChild(line1);
  wrapper.appendChild(line2);
  wrapper.appendChild(line3);

      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.justifyContent = "flex-end";
      actions.style.gap = "6px";
      actions.style.marginTop = "4px";
      actions.style.alignItems = "center";

      if (canEditOrDelete(b)) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "btn-secondary";
        editBtn.style.fontSize = "11px";
        editBtn.style.padding = "3px 10px";
        editBtn.addEventListener("click", () => startEdit(b));
        actions.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "btn-secondary";
        delBtn.style.fontSize = "11px";
        delBtn.style.padding = "3px 10px";
        delBtn.style.background = "#fee2e2";
        delBtn.style.border = "1px solid #fecaca";
        delBtn.style.color = "#b91c1c";
        delBtn.addEventListener("click", async () => {
          const ok = confirm(
            `${b.technician} – ${b.task || "assignment"}\n` + `${formatDateTime(s)} → ${formatDateTime(e)}\n\nDelete?`
          );
          if (ok) await deleteDoc(doc(bookingsCol, b.id));
        });
        actions.appendChild(delBtn);
      } else {
        const ro = document.createElement("div");
        ro.style.fontSize = "10px";
        ro.style.color = "#6b7280";
        ro.textContent = "read-only";
        actions.appendChild(ro);
      }

      wrapper.appendChild(actions);
      bookingsListEl.appendChild(wrapper);
    });
  }

  // rounding on inputs
  ["change", "blur"].forEach((evName) => {
    startInput.addEventListener(evName, () => normalizeInputTo30(startInput));
    endInput.addEventListener(evName, () => normalizeInputTo30(endInput));
  });

  addBtn.addEventListener("click", async () => {
    errorEl.textContent = "";

    normalizeInputTo30(startInput);
    normalizeInputTo30(endInput);

    let technician = technicianSelect.value;
    const task = taskInput.value.trim();
    const start = toJSDate(startInput.value);
    const end = toJSDate(endInput.value);

    if (!technician || !start || !end) {
      errorEl.textContent = "Please fill technician and both dates.";
      return;
    }
    if (end <= start) {
      errorEl.textContent = "End must be later than start.";
      return;
    }

    // Enforce: technician can only create for themselves
    if (!canCreateForTechnician(technician)) {
      errorEl.textContent = "You cannot create bookings for other technicians.";
      return;
    }

    // Overbooking check for THIS technician
    const conflicts = bookings.filter((b) => {
      if (b.technician !== technician) return false;
      if (editingBookingId && b.id === editingBookingId) return false;
      const s = b.start.toDate();
      const e = b.end.toDate();
      return overlaps(start, end, s, e);
    });

    if (conflicts.length > 0) {
      const c = conflicts[0];
      const s = c.start.toDate();
      const e = c.end.toDate();
      errorEl.textContent =
        `Overbooking: ${technician} is already booked on ${s.toLocaleDateString()} ` +
        `(${s.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}–` +
        `${e.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}).`;
      return;
    }

    // Optional: your 3h/day limit for technicians booking themselves (still in UI)
    if (isTechnician() && currentProfile?.technicianName) {
      const bookingDay = start;
      const dayBookings = bookings.filter((b) => {
        if (b.technician !== currentProfile.technicianName) return false;
        if (editingBookingId && b.id === editingBookingId) return false;
        const s = b.start.toDate();
        return sameDay(s, bookingDay) && b.createdByEmail === currentEmail; // only "self-bookings"
      });

      let usedHours = 0;
      dayBookings.forEach((b) => {
        const s = b.start.toDate();
        const e = b.end.toDate();
        usedHours += (e - s) / (1000 * 60 * 60);
      });

      const newHours = (end - start) / (1000 * 60 * 60);
      if (usedHours + newHours > 3.01) {
        errorEl.textContent = "Technicians can book themselves for up to 3 hours per day.";
        return;
      }
    }

    try {
      if (!editingBookingId) {
        await addDoc(bookingsCol, {
          technician,
          task,
          start: Timestamp.fromDate(start),
          end: Timestamp.fromDate(end),
          createdAt: Timestamp.now(),

          // NEW canonical fields
          createdByEmail: currentEmail,
          createdByUid: currentUid,
          createdByDisplayName: currentProfile?.displayName || currentEmail
        });
      } else {
        const ref = doc(bookingsCol, editingBookingId);
        await updateDoc(ref, {
          technician,
          task,
          start: Timestamp.fromDate(start),
          end: Timestamp.fromDate(end)
        });
      }

      resetFormToNew();
    } catch (e) {
      console.error(e);
      errorEl.textContent = "Error while saving booking.";
    }
  });

  document.getElementById("prevMonth").addEventListener("click", () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    renderCalendar();
    renderBookingsList();
  });

  document.getElementById("nextMonth").addEventListener("click", () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    renderCalendar();
    renderBookingsList();
  });

  document.getElementById("todayBtn").addEventListener("click", () => {
    const now = new Date();
    currentMonth = now.getMonth();
    currentYear = now.getFullYear();
    renderCalendar();
    renderBookingsList();
  });

   technicianFilter.addEventListener("change", () => {
  currentFilterTechnician = technicianFilter.value;
  renderCalendar();
  renderBookingsList();
});

  // -------------------------
  // Auth gating + Firestore subscription
  // -------------------------
  let unsubscribeBookings = null;

  onAuthStateChanged(auth, async (user) => {
    // stop previous listener
    if (unsubscribeBookings) {
      unsubscribeBookings();
      unsubscribeBookings = null;
    }

    if (!user) {
      currentProfile = null;
      currentEmail = null;
      currentUid = null;

      userLabelEl.textContent = "";
      showLogin();
      bookings = [];
      renderCalendar();
      renderBookingsList();
      return;
    }

    hideLogin();

    currentEmail = user.email || null;
    currentUid = user.uid;

    // Require profile in /users/{uid}
    currentProfile = await loadProfile(user.uid);

    if (!currentProfile) {
      // Signed in but not provisioned => lock
      userLabelEl.textContent = user.email || "Unknown";
      alert("Your account is not provisioned in the system. Contact admin.");
      await signOut(auth);
      return;
    }

    userLabelEl.textContent = currentProfile.displayName || (user.email || "User");

    // Lock technician select if technician role
// Lock technician select if technician role
if (isTechnician()) {
  technicianSelect.value = currentProfile?.technicianName || TECHNICIANS[0];
  technicianSelect.disabled = true;
} else {
  technicianSelect.disabled = false;
}

    // Absence button visible for: ADMIN + TECHNICIAN (NOT researcher)
if (isAdmin() || isTechnician()) {
  addAbsenceBtn.style.display = "inline-flex";
} else {
  addAbsenceBtn.style.display = "none";
}


// FILTER (role-specific options)
filterContainer.style.display = "block";
buildFilterOptionsForRole();
currentFilterTechnician = "ALL";
technicianFilter.value = "ALL";




    resetFormToNew();

  


    // Subscribe (ALL bookings for everyone; filtering happens in UI)
    const qBookings = query(bookingsCol, orderBy("start"));

    unsubscribeBookings = onSnapshot(
      qBookings,
      (snapshot) => {
        bookings = snapshot.docs.map((docSnap) => ({
          id: docSnap.id,
          ...docSnap.data()
        }));

        renderCalendar();
        renderBookingsList();

        if (editingBookingId && !bookings.find((b) => b.id === editingBookingId)) {
          resetFormToNew();
        }
      },
      (err) => {
        console.error("onSnapshot error:", err);
        bookingsListEl.textContent = "Error loading data (see console).";
      }
    );
  }); // ✅ TO DOMYKA onAuthStateChanged

  // initial UI (before login)
  setDefaultDateTimeInputs();
  renderCalendar();
  renderBookingsList();
</script>




  
</body>
</html>
























