<script type="module">
  // --- 1. Firebase imports (CDN) ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    query,
    orderBy,
    Timestamp,
    doc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // --- 2. Firebase config (Twój) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBz9WjF4aUhrCujzpzn4DHGX1MW--sV7iQ",
    authDomain: "lab-technicians-booking.firebaseapp.com",
    projectId: "lab-technicians-booking",
    storageBucket: "lab-technicians-booking.firebasestorage.app",
    messagingSenderId: "897254183022",
    appId: "1:897254183022:web:5ed0e7b98fa5553717967f",
    measurementId: "G-ZF5Z2GLBK7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const bookingsCol = collection(db, "bookings");

  // --- 3. "Logowanie" – imię / inicjały ---
  let currentUser = localStorage.getItem("labTechBookingUser");
  if (!currentUser) {
    currentUser =
      prompt(
        "Type your name / initials (this will be shown as 'created by'):",
        "WP"
      ) || "unknown";
    currentUser = currentUser.trim() || "unknown";
    localStorage.setItem("labTechBookingUser", currentUser);
  }
  document.getElementById("currentUserLabel").textContent = currentUser;

  // --- 4. Stan aplikacji ---
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();
  let bookings = []; // {id, technician, task, start(Timestamp), end(Timestamp), createdBy}

  const monthTitleEl = document.getElementById("monthTitle");
  const calendarGridEl = document.getElementById("calendarGrid");
  const errorEl = document.getElementById("error");

  const technicianSelect = document.getElementById("technician");
  const taskInput = document.getElementById("task");
  const startInput = document.getElementById("start");
  const endInput = document.getElementById("end");
  const addBtn = document.getElementById("addBookingBtn");

  // --- 4a. Role: technicy z ograniczeniami ---
  const TECH_LIMITED = ["Sasi", "Viviana", "Simon", "Lara", "Stefanija"];
  const MAX_TECH_BLOCK_HOURS = 3;

  let isTechLimited = false;
  let techFixedName = null;

  (function detectRole() {
    const normalizedUser = currentUser.trim().toLowerCase();
    for (const t of TECH_LIMITED) {
      if (t.toLowerCase() === normalizedUser) {
        isTechLimited = true;
        techFixedName = t;
        break;
      }
    }

    if (isTechLimited && techFixedName) {
      technicianSelect.value = techFixedName;
      technicianSelect.disabled = true;
      document.getElementById("currentUserLabel").textContent =
        techFixedName + " (technician)";
    }
  })();

  // --- 5. Helpers ---
  function toJSDate(value) {
    if (!value) return null;
    return new Date(value);
  }

  function sameDay(d1, d2) {
    return (
      d1.getFullYear() === d2.getFullYear() &&
      d1.getMonth() === d2.getMonth() &&
      d1.getDate() === d2.getDate()
    );
  }

  function overlaps(aStart, aEnd, bStart, bEnd) {
    return aStart < bEnd && bStart < aEnd;
  }

  function formatDateTime(dt) {
    return dt.toLocaleString([], {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function technicianClass(name) {
    const n = name.toLowerCase();
    if (n === "sasi") return "sasi";
    if (n === "viviana") return "viviana";
    if (n === "simon") return "simon";
    if (n === "lara") return "lara";
    return "stefanija";
  }

  // --- 6. Render kalendarza ---
  function renderCalendar() {
    calendarGridEl.innerHTML = "";

    const firstDay = new Date(currentYear, currentMonth, 1);
    const firstWeekday = (firstDay.getDay() + 6) % 7; // pon=0
    const prevMonthDays = firstWeekday;
    const totalCells = 42; // 6 tygodni

    const today = new Date();

    for (let i = 0; i < totalCells; i++) {
      const cell = document.createElement("div");
      cell.className = "day-cell";

      const dayNumberEl = document.createElement("div");
      dayNumberEl.className = "day-number";

      const dateObj = new Date(currentYear, currentMonth, 1 - prevMonthDays + i);
      const isCurrentMonth = dateObj.getMonth() === currentMonth;

      if (!isCurrentMonth) {
        cell.classList.add("other-month");
      }
      if (sameDay(dateObj, today)) {
        cell.classList.add("today");
      }

      dayNumberEl.textContent = dateObj.getDate();
      cell.appendChild(dayNumberEl);

      // bookingi dla tego dnia
      const startOfDay = new Date(dateObj);
      startOfDay.setHours(0, 0, 0, 0);
      const endOfDay = new Date(dateObj);
      endOfDay.setHours(23, 59, 59, 999);

      const dayBookings = bookings
        .filter((b) => {
          const s = b.start.toDate();
          const e = b.end.toDate();
          return overlaps(s, e, startOfDay, endOfDay);
        })
        .sort((a, b) => a.start.toMillis() - b.start.toMillis());

      dayBookings.forEach((b) => {
        const pill = document.createElement("div");
        pill.className = "pill " + technicianClass(b.technician);

        const s = b.start.toDate();
        const e = b.end.toDate();
        const timeLabel = sameDay(s, e)
          ? `${s.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit"
            })}-${e.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit"
            })}`
          : `${s.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit"
            })} → ${e.toLocaleDateString([], {
              month: "2-digit",
              day: "2-digit"
            })}`;

        pill.textContent = `${b.technician}: ${
          b.task || "booking"
        } (${timeLabel})`;
        pill.title = `${b.technician} – ${b.task || "booking"}\n${formatDateTime(
          s
        )}  →  ${formatDateTime(e)}\nCreated by: ${b.createdBy}`;

        pill.addEventListener("click", async (ev) => {
          ev.stopPropagation();
          if (b.createdBy !== currentUser) {
            alert(
              `This booking was created by ${b.createdBy}. You cannot delete or edit it.`
            );
            return;
          }
          const ok = confirm(
            `${b.technician} – ${b.task || "booking"}\n${formatDateTime(
              s
            )} → ${formatDateTime(
              e
            )}\n\nDelete this booking? (editing will come later)`
          );
          if (ok) {
            await deleteDoc(doc(bookingsCol, b.id));
          }
        });

        cell.appendChild(pill);
      });

      calendarGridEl.appendChild(cell);
    }

    const monthName = new Date(currentYear, currentMonth, 1).toLocaleString(
      "en",
      {
        month: "long",
        year: "numeric"
      }
    );
    monthTitleEl.textContent = monthName;
  }

  // --- 7. Dodawanie bookingów (overbooking + limit 3h + no backdating) ---
  addBtn.addEventListener("click", async () => {
    errorEl.textContent = "";
    let technician = technicianSelect.value;
    const task = taskInput.value.trim();
    const start = toJSDate(startInput.value);
    const end = toJSDate(endInput.value);

    if (!technician || !start || !end) {
      errorEl.textContent = "Please fill technician and both dates.";
      return;
    }
    if (end <= start) {
      errorEl.textContent = "End must be later than start.";
      return;
    }

    // NEW: block backdating (start must be today or later)
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    if (start < todayStart) {
      errorEl.textContent = "You cannot create bookings in the past.";
      return;
    }

    // Jeśli to technik z ograniczeniami:
    if (isTechLimited && techFixedName) {
      technician = techFixedName;
      const diffHours = (end - start) / (1000 * 60 * 60);
      if (diffHours > MAX_TECH_BLOCK_HOURS) {
        errorEl.textContent = `As technician you can book at most ${MAX_TECH_BLOCK_HOURS} hours in one block.`;
        return;
      }
    }

    // Overbooking check dla TEGO technika
    const conflicts = bookings.filter((b) => {
      if (b.technician !== technician) return false;
      const s = b.start.toDate();
      const e = b.end.toDate();
      return overlaps(start, end, s, e);
    });

    if (conflicts.length > 0) {
      const c = conflicts[0];
      const s = c.start.toDate();
      const e = c.end.toDate();
      errorEl.textContent = `Overbooking: ${technician} is already booked on ${s.toLocaleDateString()} (${s.toLocaleTimeString(
        [],
        { hour: "2-digit", minute: "2-digit" }
      )}–${e.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      })}).`;
      return;
    }

    try {
      await addDoc(bookingsCol, {
        technician,
        task,
        start: Timestamp.fromDate(start),
        end: Timestamp.fromDate(end),
        createdBy: currentUser,
        createdAt: Timestamp.now()
      });
      taskInput.value = "";
    } catch (e) {
      console.error(e);
      errorEl.textContent = "Error while saving booking.";
    }
  });

  // --- 8. Nawigacja po miesiącach ---
  document.getElementById("prevMonth").addEventListener("click", () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    renderCalendar();
  });
  document.getElementById("nextMonth").addEventListener("click", () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    renderCalendar();
  });
  document.getElementById("todayBtn").addEventListener("click", () => {
    const now = new Date();
    currentMonth = now.getMonth();
    currentYear = now.getFullYear();
    renderCalendar();
  });

  // --- 9. Real-time Firestore sync ---
  const qBookings = query(bookingsCol, orderBy("start"));
  onSnapshot(qBookings, (snapshot) => {
    bookings = snapshot.docs.map((docSnap) => ({
      id: docSnap.id,
      ...docSnap.data()
    }));
    renderCalendar();
  });

  // --- 10. Domyślne wartości dat (zaokrąglone do 30 min) ---
  function setDefaultDateTimeInputs() {
    const now = new Date();
    const round = Math.ceil(now.getMinutes() / 30) * 30;
    now.setMinutes(round, 0, 0);
    const end = new Date(now.getTime() + 60 * 60 * 1000);

    function toInputValue(d) {
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60 * 1000);
      return local.toISOString().slice(0, 16);
    }

    startInput.value = toInputValue(now);
    endInput.value = toInputValue(end);
  }
  setDefaultDateTimeInputs();
  renderCalendar();
</script>
