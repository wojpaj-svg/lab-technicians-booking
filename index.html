<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Technician booking </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #d5dde8;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --accent: #0ea5e9;
      --pill-radius: 999px;
      --sasi: #22c55e;
      --viviana: #6366f1;
      --simon: #0ea5e9;
      --lara: #f97316;
      --stefanija: #eab308;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      background: var(--bg);
      color: var(--text-main);
      padding: 16px;
      display: flex;
      justify-content: center;
    }
    .app {
      background: var(--card);
      border-radius: 16px;
      padding: 20px 20px 24px;
      max-width: 1100px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.25);
    }
    h1 {
      font-size: 20px;
      font-weight: 600;
    }
    .subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }
    .user-label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .user-name {
      font-weight: 600;
      color: var(--accent);
    }

    .top-row {
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.6fr);
      gap: 16px;
      margin-bottom: 12px;
    }
    .card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px 12px 14px;
      border: 1px solid var(--border);
    }
    .card h2 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .legend {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 2px 8px;
      border-radius: var(--pill-radius);
      background: #e5e7eb;
      font-size: 11px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 8px;
    }
    label {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 3px;
    }
    select, input[type="text"], input[type="datetime-local"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
      background: white;
    }
    select:focus, input:focus {
      outline: 2px solid rgba(14, 165, 233, 0.4);
      border-color: var(--accent);
    }
    .form-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }
    button {
      border: none;
      border-radius: var(--pill-radius);
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: var(--text-main);
    }
    .error {
      font-size: 11px;
      color: #dc2626;
      margin-top: 4px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      margin-top: 8px;
    }
    .month-title {
      font-weight: 600;
      font-size: 14px;
    }
    .month-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .nav-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 11px;
      cursor: pointer;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
    }
    .weekday {
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .day-cell {
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid var(--border);
      min-height: 78px;
      padding: 4px 4px 4px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
      position: relative;
      overflow: hidden;
    }
    .day-number {
      font-weight: 500;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .day-cell.today .day-number {
      color: var(--accent);
      font-weight: 700;
    }
    .day-cell.other-month {
      background: #f3f4f6;
      opacity: 0.7;
    }
    .pill {
      border-radius: var(--pill-radius);
      padding: 2px 6px;
      font-size: 10px;
      color: white;
      cursor: pointer;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      border: 1px solid rgba(15,23,42,0.08);
    }
    .pill.sasi { background: var(--sasi); }
    .pill.viviana { background: var(--viviana); }
    .pill.simon { background: var(--simon); }
    .pill.lara { background: var(--lara); }
    .pill.stefanija { background: var(--stefanija); }

    .info-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .top-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-header">
      <div>
        <div class="title-row">
          <div class="status-dot"></div>
          <h1>Technician booking </h1>
        </div>
        <div class="subtitle">
         
        </div>
      </div>
      <div class="user-label">
        Logged in as: <span class="user-name" id="currentUserLabel"></span>
      </div>
    </div>

    <div class="top-row">
      <div class="card">
        <h2>New booking</h2>
        <div class="form-grid">
          <div>
            <label for="technician">Technician</label>
            <select id="technician">
              <option value="Sasi">Sasi</option>
              <option value="Viviana">Viviana</option>
              <option value="Simon">Simon</option>
              <option value="Lara">Lara</option>
              <option value="Stefanija">Stefanija</option>
            </select>
          </div>
          <div>
            <label for="task">Task / booking description</label>
            <input id="task" type="text" placeholder="inventory, BET, lab tour..." />
          </div>
          <div>
            <label for="start">Date &amp; time from</label>
            <input id="start" type="datetime-local" step="1800" />
          </div>
          <div>
            <label for="end">Date &amp; time to</label>
            <input id="end" type="datetime-local" step="1800" />
          </div>
        </div>
        <div class="form-actions">
          <button class="btn-primary" id="addBookingBtn">Add booking</button>
          <div class="error" id="error"></div>
        </div>
        <div class="info-text">
          Time step = 30 min. Overlaps for the same technician are blocked.
        </div>
      </div>

      <div class="card">
        <h2>Legend</h2>
        <div class="legend">
          <div class="legend-item"><span class="legend-dot" style="background: var(--sasi)"></span>Sasi</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--viviana)"></span>Viviana</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--simon)"></span>Simon</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--lara)"></span>Lara</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--stefanija)"></span>Stefanija</div>
        </div>
        <div class="info-text" style="margin-top:50px">
          Click the colored bar to see the details.
If it’s your booking, you can delete it.  
          
        </div>
      </div>
    </div>

    <div class="card">
      <div class="calendar-header">
        <div class="month-title" id="monthTitle"></div>
        <div class="month-nav">
          <button class="nav-btn" id="prevMonth">&lt;</button>
          <button class="nav-btn" id="todayBtn">Today</button>
          <button class="nav-btn" id="nextMonth">&gt;</button>
        </div>
      </div>
      <div class="calendar-grid">
        <div class="weekday">Mon</div>
        <div class="weekday">Tue</div>
        <div class="weekday">Wed</div>
        <div class="weekday">Thu</div>
        <div class="weekday">Fri</div>
        <div class="weekday">Sat</div>
        <div class="weekday">Sun</div>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <!-- LISTA BOOKINGÓW POD KALENDARZEM -->
    <div class="card" style="margin-top:12px;">
      <h2>Bookings list</h2>
      <div id="bookingList" class="info-text">
        No bookings yet.
      </div>
    </div>
  </div>

  <script type="module">
    // --- 1. Firebase imports (CDN) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      Timestamp,
      doc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- 2. Your Firebase config – już wklejone ---
    const firebaseConfig = {
      apiKey: "AIzaSyBz9WjF4aUhrCujzpzn4DHGX1MW--sV7iQ",
      authDomain: "lab-technicians-booking.firebaseapp.com",
      projectId: "lab-technicians-booking",
      storageBucket: "lab-technicians-booking.firebasestorage.app",
      messagingSenderId: "897254183022",
      appId: "1:897254183022:web:5ed0e7b98fa5553717967f",
      measurementId: "G-ZF5Z2GLBK7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const bookingsCol = collection(db, "bookings");

    // --- 3. "Logowanie" – pyta ZA KAŻDYM razem, proponuje ostatnią wartość ---
    let currentUserStored = localStorage.getItem("labTechBookingUser") || "";
    let currentUser = prompt(
      "Type your name / initials (this will be shown as 'created by'):",
      currentUserStored || "WP"
    ) || currentUserStored || "unknown";
    currentUser = currentUser.trim() || "unknown";
    localStorage.setItem("labTechBookingUser", currentUser);
    document.getElementById("currentUserLabel").textContent = currentUser;

    // --- 4. Stan aplikacji ---
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let bookings = []; // {id, technician, task, start(Timestamp), end(Timestamp), createdBy}

    const monthTitleEl = document.getElementById("monthTitle");
    const calendarGridEl = document.getElementById("calendarGrid");
    const errorEl = document.getElementById("error");
    const bookingListEl = document.getElementById("bookingList");

    const technicianSelect = document.getElementById("technician");
    const taskInput = document.getElementById("task");
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const addBtn = document.getElementById("addBookingBtn");

    // --- 5. Helpers ---
    function toJSDate(value) {
      if (!value) return null;
      return new Date(value);
    }

    function sameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }

    function overlaps(aStart, aEnd, bStart, bEnd) {
      return aStart < bEnd && bStart < aEnd;
    }

    function formatDateTime(dt) {
      return dt.toLocaleString([], {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function formatDateOnly(dt) {
      return dt.toLocaleDateString([], {
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      });
    }

    function formatTimeOnly(dt) {
      return dt.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function technicianClass(name) {
      const n = name.toLowerCase();
      if (n === "sasi") return "sasi";
      if (n === "viviana") return "viviana";
      if (n === "simon") return "simon";
      if (n === "lara") return "lara";
      return "stefanija";
    }

    function pad2(n) {
      return String(n).padStart(2, "0");
    }

    // --- zaokrąglanie do :00 / :30 po zmianie pola datetime-local ---
    function snapToHalfHour(inputEl) {
      if (!inputEl.value) return;
      const d = new Date(inputEl.value);
      if (isNaN(d.getTime())) return;

      let h = d.getHours();
      let m = d.getMinutes();

      if (m < 15) m = 0;
      else if (m < 45) m = 30;
      else {
        m = 0;
        h += 1;
        if (h >= 24) {
          h = 0;
          d.setDate(d.getDate() + 1);
        }
      }

      d.setHours(h, m, 0, 0);
      const localStr =
        d.getFullYear() + "-" +
        pad2(d.getMonth() + 1) + "-" +
        pad2(d.getDate()) + "T" +
        pad2(d.getHours()) + ":" +
        pad2(d.getMinutes());
      inputEl.value = localStr;
    }

    startInput.addEventListener("change", () => snapToHalfHour(startInput));
    endInput.addEventListener("change", () => snapToHalfHour(endInput));

    // --- 6. Render kalendarza ---
    function renderCalendar() {
      calendarGridEl.innerHTML = "";

      const firstDay = new Date(currentYear, currentMonth, 1);
      const firstWeekday = (firstDay.getDay() + 6) % 7; // pon=0
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      const prevMonthDays = firstWeekday;
      const totalCells = 42; // 6 tygodni

      const today = new Date();

      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement("div");
        cell.className = "day-cell";

        const dayNumberEl = document.createElement("div");
        dayNumberEl.className = "day-number";

        const dateObj = new Date(currentYear, currentMonth, 1 - prevMonthDays + i);
        const isCurrentMonth = dateObj.getMonth() === currentMonth;

        if (!isCurrentMonth) {
          cell.classList.add("other-month");
        }
        if (sameDay(dateObj, today)) {
          cell.classList.add("today");
        }

        dayNumberEl.textContent = dateObj.getDate();
        cell.appendChild(dayNumberEl);

        // bookingi dla tego dnia
        const startOfDay = new Date(dateObj);
        startOfDay.setHours(0,0,0,0);
        const endOfDay = new Date(dateObj);
        endOfDay.setHours(23,59,59,999);

        const dayBookings = bookings
          .filter(b => {
            const s = b.start.toDate();
            const e = b.end.toDate();
            return overlaps(s, e, startOfDay, endOfDay);
          })
          .sort((a,b) => a.start.toMillis() - b.start.toMillis());

        // grupowanie po godzinie startu → w jednym wierszu (Sasi + Lara obok siebie)
        const groups = [];
        dayBookings.forEach(b => {
          const s = b.start.toDate();
          const key = pad2(s.getHours()) + ":" + pad2(s.getMinutes());
          let g = groups.find(x => x.key === key);
          if (!g) {
            g = { key, items: [] };
            groups.push(g);
          }
          g.items.push(b);
        });

        groups.forEach(group => {
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.gap = "2px";

          group.items.forEach(b => {
            const pill = document.createElement("div");
            pill.className = "pill " + technicianClass(b.technician);
            pill.style.flex = "1 1 0";

            const s = b.start.toDate();
            const e = b.end.toDate();

            const timeLabel =
              sameDay(s, e)
                ? `${s.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}-${e.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}`
                : `${s.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})} → ${e.toLocaleDateString([], {month:"2-digit", day:"2-digit"})}`;

            pill.textContent = `${b.technician}: ${b.task || "booking"} (${timeLabel})`;
            pill.title = `${b.technician} – ${b.task || "booking"}\n${formatDateTime(s)}  →  ${formatDateTime(e)}\nCreated by: ${b.createdBy}`;

            pill.addEventListener("click", async (ev) => {
              ev.stopPropagation();
              if (b.createdBy !== currentUser) {
                alert(`This booking was created by ${b.createdBy}. You cannot delete it.`);
                return;
              }
              const ok = confirm(
                `${b.technician} – ${b.task || "booking"}\n${formatDateTime(s)} → ${formatDateTime(e)}\n\nDelete this booking?`
              );
              if (ok) {
                await deleteDoc(doc(bookingsCol, b.id));
              }
            });

            row.appendChild(pill);
          });

          cell.appendChild(row);
        });

        calendarGridEl.appendChild(cell);
      }

      const monthName = new Date(currentYear, currentMonth, 1).toLocaleString("en", {
        month: "long",
        year: "numeric"
      });
      monthTitleEl.textContent = monthName;
    }

    // --- 7. Lista bookingów pod kalendarzem ---
    function renderBookingList() {
      if (!bookingListEl) return;
      if (!bookings.length) {
        bookingListEl.textContent = "No bookings yet.";
        return;
      }
      bookingListEl.innerHTML = "";

      bookings.forEach(b => {
        const row = document.createElement("div");
        row.className = "booking-row";
        row.dataset.id = b.id;
        row.style.display = "flex";
        row.style.justifyContent = "space-between";
        row.style.alignItems = "center";
        row.style.gap = "6px";
        row.style.fontSize = "11px";
        row.style.padding = "4px 6px";
        row.style.borderRadius = "6px";
        row.style.background = "#eef2ff";
        row.style.marginBottom = "4px";

        const s = b.start.toDate();
        const e = b.end.toDate();

        const left = document.createElement("div");
        left.innerHTML =
          `<strong>${b.technician}</strong> – ${b.task || "booking"}<br>` +
          `${formatDateOnly(s)} ${formatTimeOnly(s)} → ${formatDateOnly(e)} ${formatTimeOnly(e)}<br>` +
          `<span style="color:#6b7280;">Created by: ${b.createdBy}</span>`;

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.gap = "4px";

        if (b.createdBy === currentUser) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.style.border = "none";
          delBtn.style.borderRadius = "999px";
          delBtn.style.padding = "2px 10px";
          delBtn.style.fontSize = "10px";
          delBtn.style.cursor = "pointer";
          delBtn.style.background = "#fee2e2";
          delBtn.style.color = "#b91c1c";

          delBtn.addEventListener("click", async () => {
            const ok = confirm("Delete this booking?");
            if (!ok) return;
            await deleteDoc(doc(bookingsCol, b.id));
          });

          right.appendChild(delBtn);
        } else {
          const roSpan = document.createElement("span");
          roSpan.textContent = "read-only";
          roSpan.style.fontSize = "10px";
          roSpan.style.color = "#6b7280";
          right.appendChild(roSpan);
        }

        row.appendChild(left);
        row.appendChild(right);
        bookingListEl.appendChild(row);
      });
    }

    // --- 8. Obsługa formularza: dodawanie bookingów z overbooking-check ---
    addBtn.addEventListener("click", async () => {
      errorEl.textContent = "";
      const technician = technicianSelect.value;
      const task = taskInput.value.trim();
      const start = toJSDate(startInput.value);
      const end = toJSDate(endInput.value);

      if (!technician || !start || !end) {
        errorEl.textContent = "Please fill technician and both dates.";
        return;
      }
      if (end <= start) {
        errorEl.textContent = "End must be later than start.";
        return;
      }

      // Overbooking check dla TEGO technika
      const conflicts = bookings.filter(b => {
        if (b.technician !== technician) return false;
        const s = b.start.toDate();
        const e = b.end.toDate();
        return overlaps(start, end, s, e);
      });

      if (conflicts.length > 0) {
        const c = conflicts[0];
        const s = c.start.toDate();
        const e = c.end.toDate();
        errorEl.textContent =
          `Overbooking: ${technician} is already booked on ${s.toLocaleDateString()} (${s.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})}–${e.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})}).`;
        return;
      }

      try {
        await addDoc(bookingsCol, {
          technician,
          task,
          start: Timestamp.fromDate(start),
          end: Timestamp.fromDate(end),
          createdBy: currentUser,
          createdAt: Timestamp.now()
        });
        taskInput.value = "";
      } catch (e) {
        console.error(e);
        errorEl.textContent = "Error while saving booking.";
      }
    });

    // --- 9. Nawigacja po miesiącach ---
    document.getElementById("prevMonth").addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    });
    document.getElementById("nextMonth").addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    });
    document.getElementById("todayBtn").addEventListener("click", () => {
      const now = new Date();
      currentMonth = now.getMonth();
      currentYear = now.getFullYear();
      renderCalendar();
    });

    // --- 10. Real-time Firestore sync ---
    const qBookings = query(bookingsCol, orderBy("start"));
    onSnapshot(qBookings, (snapshot) => {
      bookings = snapshot.docs.map(docSnap => ({
        id: docSnap.id,
        ...docSnap.data()
      }));
      renderCalendar();
      renderBookingList();
    });

    // Ustaw domyślne wartości pól daty na dziś z zaokrągleniem do 30 min
    function setDefaultDateTimeInputs() {
      const now = new Date();
      const round = Math.ceil(now.getMinutes() / 30) * 30;
      now.setMinutes(round, 0, 0);
      const end = new Date(now.getTime() + 60 * 60 * 1000);

      function toInputValue(d) {
        const off = d.getTimezoneOffset();
        const local = new Date(d.getTime() - off * 60 * 1000);
        return local.toISOString().slice(0, 16);
      }

      startInput.value = toInputValue(now);
      endInput.value = toInputValue(end);
    }
    setDefaultDateTimeInputs();
    renderCalendar();
  </script>
</body>
</html>








