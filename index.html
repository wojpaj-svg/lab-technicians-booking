<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lab technician scheduling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #d5dde8;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --accent: #0ea5e9;
      --pill-radius: 999px;
      --sasi: #22c55e;
      --viviana: #6366f1;
      --simon: #0ea5e9;
      --lara: #f97316;
      --stefanija: #eab308;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--text-main);
      padding: 16px;
      display: flex;
      justify-content: center;
    }
    .app {
      background: var(--card);
      border-radius: 16px;
      padding: 20px 20px 24px;
      max-width: 1100px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.25);
    }
    h1 {
      font-size: 20px;
      font-weight: 600;
    }
    .subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }
    .user-label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .user-name {
      font-weight: 600;
      color: var(--accent);
    }

    .top-row {
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.6fr);
      gap: 16px;
      margin-bottom: 12px;
    }
    .card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px 12px 14px;
      border: 1px solid var(--border);
    }
    .card h2 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .legend {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: var(--pill-radius);
      background: #e5e7eb;
      font-size: 11px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }
    .legend-info {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 8px;
    }
     .slot-row {
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .slot-row .pill {
      flex: 1 1 0;
      min-width: 0;
    }
    label {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 3px;
    }
    select, input[type="text"], input[type="datetime-local"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
      background: white;
    }
    select:focus, input:focus {
      outline: 2px solid rgba(14, 165, 233, 0.4);
      border-color: var(--accent);
    }
    .form-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }
    button {
      border: none;
      border-radius: var(--pill-radius);
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: var(--text-main);
    }
    .error {
      font-size: 11px;
      color: #dc2626;
      margin-top: 4px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      margin-top: 8px;
    }
    .month-title {
      font-weight: 600;
      font-size: 14px;
    }
    .month-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .nav-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 11px;
      cursor: pointer;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
    }
    .weekday {
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .day-cell {
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid var(--border);
      min-height: 78px;
      padding: 4px 4px 4px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
      position: relative;
      overflow: hidden;
    }
    .day-number {
      font-weight: 500;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .day-cell.today .day-number {
      color: var(--accent);
      font-weight: 700;
    }
    .day-cell.other-month {
      background: #f3f4f6;
      opacity: 0.7;
    }
    .pill {
      border-radius: var(--pill-radius);
      padding: 2px 6px;
      font-size: 10px;
      color: white;
      cursor: pointer;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      border: 1px solid rgba(15,23,42,0.08);
    }
    .pill.sasi { background: var(--sasi); }
    .pill.viviana { background: var(--viviana); }
    .pill.simon { background: var(--simon); }
    .pill.lara { background: var(--lara); }
    .pill.stefanija { background: var(--stefanija); }

    .info-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .top-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-header">
      <div>
        <div class="title-row">
          <div class="status-dot"></div>
          <h1>Lab technician scheduling</h1>
        </div>
        <div class="subtitle">
          One shared calendar; colours = technicians. Data stored in Firestore.
        </div>
      </div>
      <div class="user-label">
        Logged in as: <span class="user-name" id="currentUserLabel"></span>
      </div>
    </div>

    <div class="top-row">
      <div class="card">
        <h2>New assignment</h2>
        <div class="form-grid">
          <div>
            <label for="technician">Technician</label>
            <select id="technician">
              <option value="Sasi">Sasi</option>
              <option value="Viviana">Viviana</option>
              <option value="Simon">Simon</option>
              <option value="Lara">Lara</option>
              <option value="Stefanija">Stefanija</option>
            </select>
          </div>
          <div>
            <label for="task">Task /  description</label>
            <input id="task" type="text" placeholder="inventory, BET, lab tour..." />
          </div>
          <div>
            <label for="start">Date &amp; time from</label>
            <input id="start" type="datetime-local" step="1800" />
          </div>
          <div>
            <label for="end">Date &amp; time to</label>
            <input id="end" type="datetime-local" step="1800" />
          </div>
        </div>
        <div class="form-actions">
          <button class="btn-primary" id="addBookingBtn">Add assignment</button>
          <div class="error" id="error"></div>
        </div>
        <div class="info-text">
          Time step = 30 min (automatically rounded). Overlaps for the same technician are blocked.
        </div>
      </div>

      <div class="card">
        <h2>Legend</h2>
        <div class="legend">
          <div class="legend-item"><span class="legend-dot" style="background: var(--sasi)"></span>Sasi</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--viviana)"></span>Viviana</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--simon)"></span>Simon</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--lara)"></span>Lara</div>
          <div class="legend-item"><span class="legend-dot" style="background: var(--stefanija)"></span>Stefanija</div>
        </div>
        <div class="legend-info">
          Click a coloured bar in the calendar to view details. If it is your assignment â€“ you can delete it.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="calendar-header">
        <div class="month-title" id="monthTitle"></div>
        <div class="month-nav">
          <button class="nav-btn" id="prevMonth">&lt;</button>
          <button class="nav-btn" id="todayBtn">Today</button>
          <button class="nav-btn" id="nextMonth">&gt;</button>
        </div>
      </div>
      <div class="calendar-grid">
        <div class="weekday">Mon</div>
        <div class="weekday">Tue</div>
        <div class="weekday">Wed</div>
        <div class="weekday">Thu</div>
        <div class="weekday">Fri</div>
        <div class="weekday">Sat</div>
        <div class="weekday">Sun</div>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="card" id="bookingsCard">
      <h2>Assignments list</h2>
      <div id="bookingsList" class="info-text">
        Loadingâ€¦
      </div>
    </div>
  </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      Timestamp,
      doc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBz9WjF4aUhrCujzpzn4DHGX1MW--sV7iQ",
      authDomain: "lab-technicians-booking.firebaseapp.com",
      projectId: "lab-technicians-booking",
      storageBucket: "lab-technicians-booking.firebasestorage.app",
      messagingSenderId: "897254183022",
      appId: "1:897254183022:web:5ed0e7b98fa5553717967f",
      measurementId: "G-ZF5Z2GLBK7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const bookingsCol = collection(db, "bookings");

    // technician list for permissions
    const TECHNICIANS = ["Sasi", "Viviana", "Simon", "Lara", "Stefanija"];
    const technicianUsernames = TECHNICIANS.map((n) => n.toLowerCase());

    function normalizeName(str) {
      return (str || "").trim().toLowerCase();
    }

    // "Logowanie" â€“ inicjaÅ‚y w localStorage
    let currentUser = localStorage.getItem("labTechBookingUser");
    if (!currentUser) {
      currentUser =
        prompt(
          "Type your name / initials (this will be shown as 'created by'):",
          "WP"
        ) || "unknown";
      currentUser = currentUser.trim() || "unknown";
      localStorage.setItem("labTechBookingUser", currentUser);
    }
    document.getElementById("currentUserLabel").textContent = currentUser;

    const currentUserNorm = normalizeName(currentUser);
    const isTechnicianUser = technicianUsernames.includes(currentUserNorm);
    const ownTechName = isTechnicianUser
      ? TECHNICIANS[technicianUsernames.indexOf(currentUserNorm)]
      : null;

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let bookings = []; // {id, technician, task, start, end, createdBy}

    const monthTitleEl = document.getElementById("monthTitle");
    const calendarGridEl = document.getElementById("calendarGrid");
    const errorEl = document.getElementById("error");
    const bookingsListEl = document.getElementById("bookingsList");

    const technicianSelect = document.getElementById("technician");
    const taskInput = document.getElementById("task");
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const addBtn = document.getElementById("addBookingBtn");

    // if logged-in user is a technician: lock select to their own name
    if (isTechnicianUser && ownTechName) {
      technicianSelect.value = ownTechName;
      technicianSelect.disabled = true;
    }

    function toJSDate(value) {
      if (!value) return null;
      return new Date(value);
    }

    // ðŸ”¥ TWARDY ROUNDING DO 00 / 30
    function roundTo30(date) {
      const minutes = date.getMinutes();
      let rounded = Math.round(minutes / 30) * 30;
      if (rounded === 60) {
        date.setHours(date.getHours() + 1);
        rounded = 0;
      }
      date.setMinutes(rounded, 0, 0);
      return date;
    }

    function toLocalInputValue(d) {
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60 * 1000);
      return local.toISOString().slice(0, 16);
    }

    function normalizeInputTo30(input) {
      if (!input.value) return;
      const d = toJSDate(input.value);
      if (!d) return;
      const rounded = roundTo30(d);
      input.value = toLocalInputValue(rounded);
    }

    function sameDay(d1, d2) {
      return (
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate()
      );
    }

    function overlaps(aStart, aEnd, bStart, bEnd) {
      return aStart < bEnd && bStart < aEnd;
    }

    function formatDateTime(dt) {
      return dt.toLocaleString([], {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function technicianClass(name) {
      const n = name.toLowerCase();
      if (n === "sasi") return "sasi";
      if (n === "viviana") return "viviana";
      if (n === "simon") return "simon";
      if (n === "lara") return "lara";
      return "stefanija";
    }

        function renderCalendar() {
      calendarGridEl.innerHTML = "";

      const firstDay = new Date(currentYear, currentMonth, 1);
      const firstWeekday = (firstDay.getDay() + 6) % 7; // Mon = 0
      const prevMonthDays = firstWeekday;
      const totalCells = 42;

      const today = new Date();

      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement("div");
        cell.className = "day-cell";

        const dayNumberEl = document.createElement("div");
        dayNumberEl.className = "day-number";

        const dateObj = new Date(
          currentYear,
          currentMonth,
          1 - prevMonthDays + i
        );
        const isCurrentMonth = dateObj.getMonth() === currentMonth;

        if (!isCurrentMonth) {
          cell.classList.add("other-month");
        }
        if (sameDay(dateObj, today)) {
          cell.classList.add("today");
        }

        dayNumberEl.textContent = dateObj.getDate();
        cell.appendChild(dayNumberEl);

        const startOfDay = new Date(dateObj);
        startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(dateObj);
        endOfDay.setHours(23, 59, 59, 999);

        // wybieramy i sortujemy bookingi dla danego dnia
        const dayBookings = bookings
          .filter((b) => {
            const s = b.start.toDate();
            const e = b.end.toDate();
            return overlaps(s, e, startOfDay, endOfDay);
          })
          .sort((a, b) => {
            const sa = a.start.toDate().getTime();
            const sb = b.start.toDate().getTime();
            if (sa !== sb) return sa - sb;
            const ea = a.end.toDate().getTime();
            const eb = b.end.toDate().getTime();
            return ea - eb;
          });

        // GRUPOWANIE po tym samym przedziale czasu,
        // Å¼eby kapsuÅ‚ki z identycznymi godzinami byÅ‚y w jednym rzÄ™dzie
        let lastKey = null;
        let currentRow = null;

        dayBookings.forEach((b) => {
          const s = b.start.toDate();
          const e = b.end.toDate();

          const key = `${s.getTime()}-${e.getTime()}`;
          if (key !== lastKey) {
            // nowy rzÄ…d dla nowego przedziaÅ‚u czasu
            currentRow = document.createElement("div");
            currentRow.className = "slot-row";
            cell.appendChild(currentRow);
            lastKey = key;
          }

          const pill = document.createElement("div");
          pill.className = "pill " + technicianClass(b.technician);

          const timeLabel = sameDay(s, e)
            ? `${s.toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit"
              })}-${e.toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit"
              })}`
            : `${s.toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit"
              })} â†’ ${e.toLocaleDateString([], {
                month: "2-digit",
                day: "2-digit"
              })}`;

          pill.textContent = `${b.technician}: ${
            b.task || "assignment"
          } (${timeLabel})`;
          pill.title =
            `${b.technician} â€“ ${b.task || "assignment"}\n` +
            `${formatDateTime(s)}  â†’  ${formatDateTime(e)}\n` +
            `Created by: ${b.createdBy}`;

          pill.addEventListener("click", async (ev) => {
            ev.stopPropagation();
            if (b.createdBy !== currentUser) {
              alert(
                `This booking was created by ${b.createdBy}. You cannot delete it.`
              );
              return;
            }
            const ok = confirm(
              `${b.technician} â€“ ${b.task || "assignment"}\n` +
                `${formatDateTime(s)} â†’ ${formatDateTime(e)}\n\n` +
                `Delete this booking?`
            );
            if (ok) {
              await deleteDoc(doc(bookingsCol, b.id));
            }
          });

          currentRow.appendChild(pill);
        });

        calendarGridEl.appendChild(cell);
      }

      const monthName = new Date(currentYear, currentMonth, 1).toLocaleString(
        "en",
        {
          month: "long",
          year: "numeric"
        }
      );
      monthTitleEl.textContent = monthName;
    }


    function renderBookingsList() {
      if (!bookings.length) {
        bookingsListEl.textContent = "No bookings yet.";
        return;
      }
      bookingsListEl.innerHTML = "";
      bookings.forEach((b) => {
        const wrapper = document.createElement("div");
        wrapper.style.padding = "8px 10px";
        wrapper.style.marginTop = "6px";
        wrapper.style.borderRadius = "10px";
        wrapper.style.background = "#eef3ff";

        const s = b.start.toDate();
        const e = b.end.toDate();

        const line1 = document.createElement("div");
        line1.style.fontSize = "12px";
        line1.innerHTML = `<strong>${b.technician}</strong> â€“ ${
          b.task || "assignment"
        }`;

        const line2 = document.createElement("div");
        line2.style.fontSize = "11px";
        line2.textContent = `${formatDateTime(s)} â†’ ${formatDateTime(e)}`;

        const line3 = document.createElement("div");
        line3.style.fontSize = "11px";
        line3.textContent = `Created by: ${b.createdBy}`;

        wrapper.appendChild(line1);
        wrapper.appendChild(line2);
        wrapper.appendChild(line3);

        if (b.createdBy === currentUser) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.className = "btn-secondary";
          delBtn.style.marginTop = "4px";
          delBtn.style.fontSize = "11px";
          delBtn.style.padding = "3px 10px";
          delBtn.style.background = "#fee2e2";
          delBtn.style.border = "1px solid #fecaca";
          delBtn.style.color = "#b91c1c";

          delBtn.addEventListener("click", async () => {
            const ok = confirm(
              `${b.technician} â€“ ${b.task || "booking"}\n` +
                `${formatDateTime(s)} â†’ ${formatDateTime(e)}\n\n` +
                `Delete this booking?`
            );
            if (ok) {
              await deleteDoc(doc(bookingsCol, b.id));
            }
          });

          wrapper.appendChild(delBtn);
        } else {
          const ro = document.createElement("div");
          ro.style.fontSize = "10px";
          ro.style.marginTop = "4px";
          ro.style.color = "#6b7280";
          ro.textContent = "read-only";
          wrapper.appendChild(ro);
        }

        bookingsListEl.appendChild(wrapper);
      });
    }

    // ðŸ”¥ podpinamy zaokrÄ…glanie pod inputy
    ["change", "blur"].forEach((evName) => {
      startInput.addEventListener(evName, () => normalizeInputTo30(startInput));
      endInput.addEventListener(evName, () => normalizeInputTo30(endInput));
    });

    addBtn.addEventListener("click", async () => {
      errorEl.textContent = "";

      // twardy rounding zanim cokolwiek policzymy
      normalizeInputTo30(startInput);
      normalizeInputTo30(endInput);

      let technician = technicianSelect.value;
      const task = taskInput.value.trim();
      const start = toJSDate(startInput.value);
      const end = toJSDate(endInput.value);

      if (isTechnicianUser && ownTechName) {
        // technician user can only book themselves
        technician = ownTechName;
        technicianSelect.value = ownTechName;
      }

      if (!technician || !start || !end) {
        errorEl.textContent = "Please fill technician and both dates.";
        return;
      }
      if (end <= start) {
        errorEl.textContent = "End must be later than start.";
        return;
      }

      // Overbooking check for THIS technician (for everyone)
      const conflicts = bookings.filter((b) => {
        if (b.technician !== technician) return false;
        const s = b.start.toDate();
        const e = b.end.toDate();
        return overlaps(start, end, s, e);
      });

      if (conflicts.length > 0) {
        const c = conflicts[0];
        const s = c.start.toDate();
        const e = c.end.toDate();
        errorEl.textContent =
          `Overbooking: ${technician} is already booked on ${s.toLocaleDateString()} ` +
          `(${s.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit"
          })}â€“` +
          `${e.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit"
          })}).`;
        return;
      }

      // EXTRA LIMIT: technician users can book max 3h/day for themselves
      if (isTechnicianUser && ownTechName) {
        const bookingDay = start;
        const dayBookings = bookings.filter((b) => {
          if (b.technician !== ownTechName) return false;
          const s = b.start.toDate();
          return sameDay(s, bookingDay);
        });

        let usedHours = 0;
        dayBookings.forEach((b) => {
          const s = b.start.toDate();
          const e = b.end.toDate();
          usedHours += (e - s) / (1000 * 60 * 60);
        });

        const newHours = (end - start) / (1000 * 60 * 60);
        if (usedHours + newHours > 3.01) {
          errorEl.textContent =
            "Technicians can book themselves for up to 3 hours per day.";
          return;
        }
      }

      try {
        await addDoc(bookingsCol, {
          technician,
          task,
          start: Timestamp.fromDate(start),
          end: Timestamp.fromDate(end),
          createdBy: currentUser,
          createdAt: Timestamp.now()
        });
        taskInput.value = "";
      } catch (e) {
        console.error(e);
        errorEl.textContent = "Error while saving booking.";
      }
    });

    document.getElementById("prevMonth").addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    });
    document.getElementById("nextMonth").addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    });
    document.getElementById("todayBtn").addEventListener("click", () => {
      const now = new Date();
      currentMonth = now.getMonth();
      currentYear = now.getFullYear();
      renderCalendar();
    });

    const qBookings = query(bookingsCol, orderBy("start"));
    onSnapshot(qBookings, (snapshot) => {
      bookings = snapshot.docs.map((docSnap) => ({
        id: docSnap.id,
        ...docSnap.data()
      }));
      renderCalendar();
      renderBookingsList();
    });

    function setDefaultDateTimeInputs() {
      const now = new Date();
      const round = Math.ceil(now.getMinutes() / 30) * 30;
      now.setMinutes(round, 0, 0);
      const end = new Date(now.getTime() + 60 * 60 * 1000);

      function toInputValue(d) {
        const off = d.getTimezoneOffset();
        const local = new Date(d.getTime() - off * 60 * 1000);
        return local.toISOString().slice(0, 16);
      }

      startInput.value = toInputValue(now);
      endInput.value = toInputValue(end);
    }

    setDefaultDateTimeInputs();
    renderCalendar();
  </script>
</body>
</html>




